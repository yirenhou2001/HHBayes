---
title: "Getting Started: Simulation and Estimation for Household Transmission"
author: "Household.Transmission.Chain.Data.Analysis"
date: "`r format(Sys.Date())`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", eval = FALSE)
```

## Overview

This package provides tools to simulate household infection dynamics and estimate transmission parameters using Bayesian inference via Stan. The model incorporates viral load dynamics, seasonal forcing, and role-specific susceptibility/infectivity.

**Two main functions:**

- **`GenSyn()`** — Simulate synthetic household data and estimate parameters (for validation/benchmarking)
- **`TransmissionChainAnalysis()`** — Estimate parameters from your own observational data

## Installation

```{r install}
# Install from GitHub
devtools::install_github("yirenhou2001/Household.Transmission.Chain.Data.Analysis")

# Load the package
library(Household.Transmission.Chain.Data.Analysis)
```

---

## Quick Start Example

Here's the simplest way to run a simulation and estimate parameters:
```{r quickstart}
library(Household.Transmission.Chain.Data.Analysis)

# Create seasonal forcing (constant for simplicity)
seasonal_forcing <- list(
  adult   = rep(0.1, 365),
  child   = rep(0.1, 365),
  elderly = rep(0.1, 365),
  toddler = rep(0.1, 365)
)

# Run simulation + estimation
result <- GenSyn(

  n_households          = 50,
  seasonal_forcing_list = seasonal_forcing,
  max_days              = 365,
  stan_chains           = 2,
  stan_iter             = 1000,
  stan_warmup           = 500,
  stan_cores            = 2
)

# View estimated parameters
print(result$postprocessing)
```

---

## Example 1: Simulating Household Transmission

`GenSyn()` simulates households, runs infections through them, and estimates transmission parameters.

### Basic simulation

```{r example1-basic}
library(Household.Transmission.Chain.Data.Analysis)

# Define seasonal forcing for each role
seasonal_forcing_list <- list(
  adult   = rep(0.1, 365),
  child   = rep(0.1, 365),
  elderly = rep(0.1, 365),
  toddler = rep(0.1, 365)
)

# Simulate 100 households and estimate parameters
result <- GenSyn(

  n_households = 100,
  seasonal_forcing_list = seasonal_forcing_list,
  max_days = 365,
  

  # Transmission parameters (these are the "true" values for simulation)
  beta1 = 0.3,              # Baseline transmission
  beta2 = 0.05,             # Viral load contribution
  phi_by_role = c(adult = 1.0, child = 7.0, toddler = 7.0, elderly = 4.0),
  kappa_by_role = c(adult = 1.0, child = 1.5, toddler = 1.5, elderly = 1.0),
  
  # Stan settings
  stan_chains  = 4,
  stan_iter    = 2000,
  stan_warmup  = 1000,
  stan_control = list(adapt_delta = 0.99, max_treedepth = 15),
  stan_cores   = 4,
  
  # Plotting
  print_plots = FALSE
)

# View results
print(result)
```

### Accessing outputs

```{r example1-outputs}
# Posterior summary table
result$postprocessing

# Full Stan fit object (for advanced diagnostics)
fit <- result$results$fit

# Check convergence
rstan::check_hmc_diagnostics(fit)

# Extract specific parameters
rstan::summary(fit, pars = c("beta1", "beta2", "latent_mean"))$summary
```

---

## Example 2: Analyzing Your Own Data

Use `TransmissionChainAnalysis()` when you have real observational data.

### Input format: Per-person episode table

The recommended input format has one row per person:

```{r example2-data}
# Example data: 3 households, each with 3 people
my_data <- data.frame(
  hh_id = c("HH1", "HH1", "HH1",
            "HH2", "HH2", "HH2",
            "HH3", "HH3", "HH3"),
  person_id = c(1, 2, 3,
                1, 2, 3,
                1, 2, 3),
  role = c("adult", "child", "elderly",
           "adult", "adult", "child",
           "adult", "toddler", "elderly"),
  
  # Infection timing (NA = never infected)
  infection_time     = c(5,  8,  NA,   3,  NA, 6,   10, 12, NA),
  infectious_start   = c(6,  9,  NA,   4,  NA, 7,   11, 13, NA),
  infectious_end     = c(12, 14, NA,   10, NA, 12,  16, 18, NA),
  infection_resolved = c(14, 16, NA,   12, NA, 14,  18, 20, NA)
)

print(my_data)
```

### Running the analysis

```{r example2-analysis}
# Define seasonal forcing (length must match max_days)
T_max <- 30
seasonal_forcing_list <- list(
  adult   = rep(1, T_max),
  child   = rep(1, T_max),
  elderly = rep(1, T_max),
  toddler = rep(1, T_max)
)

# Analyze the data
result <- TransmissionChainAnalysis(
  user_data             = my_data,
  seasonal_forcing_list = seasonal_forcing_list,
  max_days              = T_max,
  
  # Stan settings (lighter for testing)
  stan_chains  = 2,
  stan_iter    = 1000,
  stan_warmup  = 500,
  stan_control = list(adapt_delta = 0.95, max_treedepth = 12),
  stan_cores   = 2
)

# View posterior estimates
print(result$postprocessing)
```

---

## Example 3: Long-Format Testing Data

If you have repeated test results rather than episode summaries:

```{r example3-longformat}
# Long-format: one row per test
test_data <- data.frame(
  HH = c(1, 1, 1, 1, 1, 1,       # Household 1, person 1
         1, 1, 1, 1, 1, 1,       # Household 1, person 2
         2, 2, 2, 2, 2, 2),      # Household 2, person 1
  individual_ID = c(1, 1, 1, 1, 1, 1,
                    2, 2, 2, 2, 2, 2,
                    1, 1, 1, 1, 1, 1),
  role = c(rep("adult", 6),
           rep("child", 6),
           rep("adult", 6)),
  test_date = c(1, 3, 5, 7, 9, 11,
                1, 3, 5, 7, 9, 11,
                1, 3, 5, 7, 9, 11),
  infection_status = c(0, 0, 1, 1, 1, 0,   # Person 1: infected days 5-9
                       0, 0, 0, 1, 1, 1,   # Person 2: infected days 7-11
                       0, 1, 1, 1, 0, 0)   # Person 3: infected days 3-7
)

# Create seasonal forcing
T_max <- 15
seasonal_forcing_list <- list(
  adult = rep(1, T_max), child = rep(1, T_max),
  elderly = rep(1, T_max), toddler = rep(1, T_max)
)

# Analyze
result <- TransmissionChainAnalysis(
  user_data = test_data,
  seasonal_forcing_list = seasonal_forcing_list,
  max_days = T_max,
  stan_chains = 2,
  stan_iter = 1000,
  stan_warmup = 500
)

print(result$postprocessing)
```

---

## Example 4: Generating Diagnostic Plots

`GenSyn()` can generate visualizations of the simulated epidemic:

```{r example4-plots}
result <- GenSyn(
  n_households = 100,
  seasonal_forcing_list = seasonal_forcing_list,
  max_days = 365,
  
  # Request specific plots
  plots = c("daily", "weekly", "timeline", "sar"),
  print_plots = TRUE,
  
  # Stan settings
  stan_chains = 2,
  stan_iter = 1000,
  stan_warmup = 500
)

# Access plots individually
result$plot_list$daily     # Daily infections by role
result$plot_list$weekly    # Weekly infections by role
result$plot_list$timeline  # Per-household infection timelines
result$plot_list$sar       # Secondary attack rate by index VL
```

### Plot descriptions

| Plot | Description |
|------|-------------|
| `daily` | Bar chart of daily new infections, colored by role |
| `weekly` | Bar chart of weekly new infections, colored by role |
| `timeline` | Faceted plot showing infection and detection timing per household |
| `sar` | Box plot of household secondary attack rate by index case viral load |
